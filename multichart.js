var dataset = [{
    "date": "2019-12",
    "url": "https://www.abc.com/?id=201912",
    "dd": [{
        "v": 0.00000000,
        "f": 0
    }, {
        "v": 0.00000000,
        "f": 0
    }, {
        "v": 0.00000000,
        "f": 0
    }, {
        "v": 0.00000000,
        "f": 0
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 0.00000000,
        "f": 0
    }, {
        "v": 0.00000000,
        "f": 0
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-01",
    "url": "https://www.abc.com/?id=202001",
    "dd": [{
        "v": 4.79706090,
        "f": "4,797,061"
    }, {
        "v": 4.79706090,
        "f": "4,797,061"
    }, {
        "v": 6.47370000,
        "f": "6,473,700"
    }, {
        "v": 6.47370000,
        "f": "6,473,700"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 734.39168100,
        "f": "734,391,681"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 3.83299764,
        "f": "3,832,998"
    }, {
        "v": 3.83299764,
        "f": "3,832,998"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-02",
    "url": "https://www.abc.com/?id=202002",
    "dd": [{
        "v": 5.01694427,
        "f": "5,016,944"
    }, {
        "v": 9.81400518,
        "f": "9,814,005"
    }, {
        "v": 10.41225469,
        "f": "10,412,255"
    }, {
        "v": 16.88595469,
        "f": "16,885,955"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 734.39183000,
        "f": "734,391,830"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 11.63450509,
        "f": "11,634,505"
    }, {
        "v": 7.80150745,
        "f": "7,801,507"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-03",
    "url": "https://www.abc.com/?id=202003",
    "dd": [{
        "v": 7.83642383,
        "f": "7,836,424"
    }, {
        "v": 17.65042900,
        "f": "17,650,429"
    }, {
        "v": 9.15912906,
        "f": "9,159,129"
    }, {
        "v": 26.04508375,
        "f": "26,045,084"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 735.09584600,
        "f": "735,095,846"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 19.71231853,
        "f": "19,712,319"
    }, {
        "v": 8.07781343,
        "f": "8,077,813"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-04",
    "url": "https://www.abc.com/?id=202004",
    "dd": [{
        "v": 11.58301201,
        "f": "11,583,012"
    }, {
        "v": 29.23344102,
        "f": "29,233,441"
    }, {
        "v": 13.87334524,
        "f": "13,873,345"
    }, {
        "v": 39.91842900,
        "f": "39,918,429"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 735.45459425,
        "f": "735,454,594"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 28.84759433,
        "f": "28,847,594"
    }, {
        "v": 9.13527579,
        "f": "9,135,276"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-05",
    "url": "https://www.abc.com/?id=202005",
    "dd": [{
        "v": 13.78325042,
        "f": "13,783,250"
    }, {
        "v": 43.01669144,
        "f": "43,016,691"
    }, {
        "v": 18.24628849,
        "f": "18,246,288"
    }, {
        "v": 58.16471750,
        "f": "58,164,718"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 737.61968250,
        "f": "737,619,683"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 45.87951271,
        "f": "45,879,513"
    }, {
        "v": 17.03191837,
        "f": "17,031,918"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-06",
    "url": "https://www.abc.com/?id=202006",
    "dd": [{
        "v": 18.74037143,
        "f": "18,740,371"
    }, {
        "v": 61.75706287,
        "f": "61,757,063"
    }, {
        "v": 18.64206150,
        "f": "18,642,062"
    }, {
        "v": 76.80677900,
        "f": "76,806,779"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 76.80677900,
        "f": "76,806,779"
    }, {
        "v": 746.19765716,
        "f": "746,197,657"
    }, {
        "v": 734.39184700,
        "f": "734,391,847"
    }, {
        "v": 58.23543730,
        "f": "58,235,437"
    }, {
        "v": 12.35592459,
        "f": "12,355,925"
    }, {
        "v": 58.23543730,
        "f": "58,235,437"
    }, {
        "v": null,
        "f": ""
    }]
}, {
    "date": "2020-07",
    "url": "https://www.abc.com/?id=202007",
    "dd": [{
        "v": 19.22276796,
        "f": "19,222,768"
    }, {
        "v": 80.97983083,
        "f": "80,979,831"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 23.6652455514,
        "f": "23,665,246"
    }, {
        "v": 100.4720245514,
        "f": "100,472,025"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 82.9027050765,
        "f": "82,902,705"
    }, {
        "v": 24.6672677794,
        "f": "24,667,268"
    }]
}, {
    "date": "2020-08",
    "url": "https://www.abc.com/?id=202008",
    "dd": [{
        "v": 20.75774473,
        "f": "20,757,745"
    }, {
        "v": 101.73757556,
        "f": "101,737,576"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 24.2161870102,
        "f": "24,216,187"
    }, {
        "v": 124.6882115616,
        "f": "124,688,212"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 108.1632482282,
        "f": "108,163,248"
    }, {
        "v": 25.2605431517,
        "f": "25,260,543"
    }]
}, {
    "date": "2020-09",
    "url": "https://www.abc.com/?id=202009",
    "dd": [{
        "v": 21.49718645,
        "f": "21,497,186"
    }, {
        "v": 123.23476200,
        "f": "123,234,762"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 24.4532837729,
        "f": "24,453,284"
    }, {
        "v": 149.1414953345,
        "f": "149,141,495"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 133.7174220198,
        "f": "133,717,422"
    }, {
        "v": 25.5541737916,
        "f": "25,554,174"
    }]
}, {
    "date": "2020-10",
    "url": "https://www.abc.com/?id=202010",
    "dd": [{
        "v": 25.71548725,
        "f": "25,715,487"
    }, {
        "v": 148.95024925,
        "f": "148,950,249"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 28.0013841026,
        "f": "28,001,384"
    }, {
        "v": 177.1428794371,
        "f": "177,142,879"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 162.6604609403,
        "f": "162,660,461"
    }, {
        "v": 28.9430389205,
        "f": "28,943,039"
    }]
}, {
    "date": "2020-11",
    "url": "https://www.abc.com/?id=202011",
    "dd": [{
        "v": 28.83896634,
        "f": "28,838,966"
    }, {
        "v": 177.78921557,
        "f": "177,789,216"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 30.8230122547,
        "f": "30,823,012"
    }, {
        "v": 207.9658916918,
        "f": "207,965,892"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 194.2289100091,
        "f": "194,228,910"
    }, {
        "v": 31.5684490688,
        "f": "31,568,449"
    }]
}, {
    "date": "2020-12",
    "url": "https://www.abc.com/?id=202012",
    "dd": [{
        "v": 28.90631327,
        "f": "28,906,313"
    }, {
        "v": 206.69552884,
        "f": "206,695,529"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 30.2987158891,
        "f": "30,298,716"
    }, {
        "v": 238.2646075809,
        "f": "238,264,608"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 225.2228834652,
        "f": "225,222,883"
    }, {
        "v": 30.9939734561,
        "f": "30,993,973"
    }]
}, {
    "date": "2021-01",
    "url": "https://www.abc.com/?id=202101",
    "dd": [{
        "v": 34.34620637,
        "f": "34,346,206"
    }, {
        "v": 241.04173519,
        "f": "241,041,735"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 32.3197450363,
        "f": "32,319,745"
    }, {
        "v": 270.5843526172,
        "f": "270,584,353"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 258.0048813846,
        "f": "258,004,881"
    }, {
        "v": 32.7819979194,
        "f": "32,781,998"
    }]
}, {
    "date": "2021-02",
    "url": "https://www.abc.com/?id=202102",
    "dd": [{
        "v": 37.21306533,
        "f": "37,213,065"
    }, {
        "v": 278.25480052,
        "f": "278,254,801"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 35.0437748269,
        "f": "35,043,775"
    }, {
        "v": 305.6281274441,
        "f": "305,628,127"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 293.4587713842,
        "f": "293,458,771"
    }, {
        "v": 35.4538899996,
        "f": "35,453,890"
    }]
}, {
    "date": "2021-03",
    "url": "https://www.abc.com/?id=202103",
    "dd": [{
        "v": 37.37844592,
        "f": "37,378,446"
    }, {
        "v": 315.63324635,
        "f": "315,633,246"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 34.9675766932,
        "f": "34,967,577"
    }, {
        "v": 340.5957041373,
        "f": "340,595,704"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 328.8596759596,
        "f": "328,859,676"
    }, {
        "v": 35.4009045754,
        "f": "35,400,905"
    }]
}, {
    "date": "2021-04",
    "url": "https://www.abc.com/?id=202104",
    "dd": [{
        "v": 34.49126407,
        "f": "34,491,264"
    }, {
        "v": 350.12451038,
        "f": "350,124,510"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 32.1408677501,
        "f": "32,140,868"
    }, {
        "v": 372.7365718874,
        "f": "372,736,572"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 361.34525487,
        "f": "361,345,255"
    }, {
        "v": 32.4855789104,
        "f": "32,485,579"
    }]
}, {
    "date": "2021-05",
    "url": "https://www.abc.com/?id=202105",
    "dd": [{
        "v": 36.84904197,
        "f": "36,849,042"
    }, {
        "v": 386.97355233,
        "f": "386,973,552"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 34.6272960243,
        "f": "34,627,296"
    }, {
        "v": 407.3638679117,
        "f": "407,363,868"
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": null,
        "f": ""
    }, {
        "v": 396.3239794492,
        "f": "396,323,979"
    }, {
        "v": 34.9787245792,
        "f": "34,978,725"
    }]
}];
    
var w = 1400;
var h = 500;
var padding = 60;
var svg = d3.select("body").append("svg").attr("width", w).attr("height", h);
var colors = ["blue", "#ff00ff", "red", "green"];
var bar_labels = ["Baseline Cost (mth)", "Actual Cost (mth)", "Forecast Cost (mth)", "Earned Value (mth)"];
var minLeft = 0, maxLeft = 4 * Math.pow(10, 7),
minRight = 0, maxRight = 8 * Math.pow(10, 8);
var bar_data = [], line_data = [];
dataset.forEach(d => {
var new_bar_set = {
    date: d.date,
    url: d.url,
    dd: []
}
var new_line_set = {
    date: d.date,
    url: d.url,            
    value1: 0,
    value1_label:'',
    value3: 0,
    value3_label:'',
    value5: 0,
    value5_label:'',
    value8: 0,
    value8_label:'',
}
var k = 0;
d.dd.forEach((e, i) => {
    if(i == 0 || i == 2 || i == 4 || i == 9){
        new_bar_set.dd.push({                    
            date: d.date,
            label: bar_labels[k],
            value: e.f,
            v: 'value' + i,
            f: e.v == null || e.v == '' ? 0 : e.v * Math.pow(10, 6)                    
        })
        k++;
    }
    switch(i){
        case 1:
            new_line_set.value1 = e.v == null || e.v == '' ? 0 : e.v * Math.pow(10, 6);
            new_line_set.value1_label = e.f == null ? '' : e.f;
        break;
        case 3:
            new_line_set.value3 = e.v == null || e.v == '' ? 0 : e.v * Math.pow(10, 6);
            new_line_set.value3_label = e.f == null ? '' : e.f;
        break;
        case 5:
            new_line_set.value5 = e.v == null || e.v == '' ? 0 : e.v * Math.pow(10, 6);
            new_line_set.value5_label = e.f == null ? '' : e.f;
        break;
        case 8:
            new_line_set.value8 = e.v == null || e.v == '' ? 0 : e.v * Math.pow(10, 6);
            new_line_set.value8_label = e.f == null ? '' : e.f;
        break;
    }            
})
bar_data.push(new_bar_set);
line_data.push(new_line_set)
});
console.log(line_data)

var dates = bar_data.map(d => d.date);
var bar_subs = bar_data[0].dd.map(d => d.v);

var x0 = d3
    .scaleBand()
    .domain(dates)
    .range([0, w - padding * 2])
    .padding(0.2),
x = d3
    .scaleBand()
    .domain(bar_subs)
    .range([0, x0.bandwidth()])
    .padding(0.2)
yLeft = d3
    .scaleLinear()
    .domain([minLeft, maxLeft])
    .rangeRound([h - padding * 2, 0]),
yRight = d3
    .scaleLinear()
    .domain([minRight, maxRight])
    .rangeRound([h - padding * 2, 0]),
xAxis = d3
    .axisBottom(x0)            
    .ticks(bar_data.length)
    .tickSize(0)
yAxisLeft = d3
    .axisLeft(yLeft),
yAxisRight = d3
    .axisRight(yRight)
    .tickSize(w - padding * 2)
    .ticks(8);

var graphArea = svg
    .append("g").attr('class', 'graphArea')
    .attr('transform', "translate(" + (padding) + "," + (padding) + ")")

var tooltip = graphArea.append('g');
//shadow effect
var defs = graphArea.append("defs");
var filter = defs.append("filter")
    .attr("id", "drop-shadow")
    .attr("height", "150%");        

filter.append("feDropShadow")
    .attr("stdDeviation", 2.5)
    .attr("flood-color", "grey")
    .attr("flood-opacity", 0.8);

var feMerge = filter.append("feMerge");
feMerge.append("feMergeNode")
    .attr("in", "offsetBlur")
feMerge.append("feMergeNode")
    .attr("in", "SourceGraphic");

var xArea = graphArea.append('g').attr('class', 'xArea')
    .attr('transform', "translate(0," + (h - padding * 2) + ")");

xArea
    .attr('class', 'x axis')
    .call(xAxis)
    .selectAll('text')
    .attr('opacity', (d, i) => i % 2 == 1 ? 0 : 1)            
    .style("font", "300 10px Arial")
    .attr('text-anchor','end')
    .attr('transform', 'rotate(-45)');

var yAreaLeft = graphArea.append('g').attr('class', 'yAreaLeft')
yAreaLeft
    .attr('class', 'y-axis-left')
    .call(yAxisLeft)
    .selectAll('text')
    .style("font", "300 10px Arial")
    .select('.domain')
    .remove();
var yAreaRight = graphArea.append('g').attr('class', 'yAreaRight')
yAreaRight
    .attr('class', 'y-axis-right')
    .call(yAxisRight)
    .selectAll('text')
    .style("font", "300 10px Arial")
    .select('.domain')
    .remove();

var slice = graphArea.selectAll(".slice")
    .data(bar_data)
    .enter().append("g")
    .attr("class", "g")
    .attr("transform", d => "translate(" + x0(d.date) + ",0)");

slice.selectAll("rect")
    .data(d => d.dd)
.enter().append("rect")
    .attr("width", x.bandwidth())
    .attr("x", d => x(d.v))
    .style("fill", (d, i) => colors[i])
    .attr("y", d => yLeft(d.f))
    .attr("height", d => h - padding * 2 - yLeft(d.f))
    .on("mouseover", function(d, i) {
        tooltip.attr('transform', 'translate(' + (x0(d.date) + x(d.v) + x.bandwidth()) + ',' + (yLeft(d.f)) + ')').call(callout, d);
        tooltip.raise();
    })
    .on("mouseout", function(d) {
        tooltip.call(callout, null);
    });
    
// slice.selectAll("rect")
//     .transition()
//     .delay(Math.random() * 1000)
//     .duration(1000)
//     .attr("y", d => yLeft(d.f))
//     .attr("height", d => h - padding * 2 - yLeft(d.f));


//draw line
// define the 1st line
var valueline0 = d3.line()
    .defined(function(d) { return d.value1 == 0 ? false :d; })
    .x(d => x0(d.date))
    .y(d => yRight(d.value1));
var valueline1 = d3.line()
    .defined(function(d) { return d.value3 == 0 ? false :d; })
    .x(d => x0(d.date))
    .y(d => yRight(d.value3));
var valueline2 = d3.line()
    .defined(function(d) { return d.value5 == 0 ? false :d; })
    .x(d => x0(d.date))
    .y(d => yRight(d.value5));
var valueline3 = d3.line()
    .defined(function(d) { return d.value8 == 0 ? false :d; })
    .x(d => x0(d.date))
    .y(d => yRight(d.value8));

graphArea
    .append("path")
    .data([line_data])
    .attr("class", "line")
    .attr("stroke", colors[0])
    .attr("stroke-width", 3)
    .attr("fill", 'none')
    .attr("d", valueline0)
    
graphArea
    .append("path")
    .data([line_data])
    .attr("class", "line")
    .attr("stroke", colors[1])
    .attr("stroke-width", 3)
    .attr("fill", 'none')
    .attr("d", valueline1);
graphArea
    .append("path")
    .data([line_data])
    .attr("class", "line")
    .attr("stroke", colors[2])
    .attr("stroke-width", 3)
    .attr("fill", 'none')
    .attr("d", valueline2);
graphArea
    .append("path")
    .data([line_data])
    .attr("class", "line")
    .attr("stroke", colors[3])
    .attr("stroke-width", 3)
    .attr("fill", 'none')
    .attr("d", valueline3);        

const callout = (g, d) => {
    
    if (!d) {
        g.selectAll("*").remove();
        return g.style('display', 'none');
    }

    g.style('display', null).style('pointer-events', 'none')

    const path = g
        .append("path")
        .attr("fill", 'white')
        .style("filter", "url(#drop-shadow)")
        .attr("stroke", "grey");

    const text = g
        .append("text");

    text.append('tspan')
        .text(d.date)
        .style('font-weight', 'bold')
        .attr('text-anchor', 'start')                
    text.append('tspan')
        .text(d.label + ": " + d.value)
        .attr('text-anchor', 'start')
        .attr('x', 0)
        .attr('dy', '.8em')

    const { width: tw, height: th } = text.node().getBBox();
    var tth = th + 10;
    text.attr("transform", 'translate(' + (-x.bandwidth() - tw - 10) + ',-6)')
        .attr('dy', '0.3em')
    path
        .attr("transform", 'translate(' + (-x.bandwidth()) + ',0)')
        .attr("d", 'M0,0l-5,-5v' + (-(tth - 10) / 2) + 'h' + (-tw - 10) + 'v' + tth + 'h' + (tw + 10) + 'v' + (-(tth - 10) / 2) + 'l5,-5z')
        
}
